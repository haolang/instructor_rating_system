<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>总览页面</title>
    <!-- 新 Bootstrap4 核心 CSS 文件 -->
    <link rel="stylesheet" href="jslib/bootstrap-4.0.0-dist/css/bootstrap.min.css">

    <!-- jQuery文件。务必在bootstrap.min.js 之前引入 -->
    <script src="jslib/jquery/jquery-3.2.1.min.js"></script>
    <script src="jslib/jquery/jquery.table2excel.js"></script>

    <!-- popper.min.js 用于弹窗、提示、下拉菜单 -->
    <script src="jslib/bootstrap-4.0.0-dist/js/popper.min.js"></script>

    <script src="jslib/bootstrap-4.0.0-dist/js/bootstrap.min.js"></script>

    <script src="jslib/Pager.js"></script>
    <style>
        /*大标题*/
        .top-container {
            margin: 20px 0;
            padding: 10px;
            background-color: #e2e3e5;
            border-radius: .25rem;
        }

        /*顶部搜索按钮部分*/
        .top-control {
            margin-bottom: 10px;
        }

        /*登陆者相关信息*/
        .login-info {
            background-color: #dddddd;
            padding: 15px;
            bottom: 0;
            /*position: absolute;*/
            border-radius: .25rem;
        }

        .input-group-addon {
            padding: 6px 12px;
            font-size: 14px;
            font-weight: 400;
            line-height: 1;
            color: #555;
            text-align: center;
            background-color: #eee;
            border: 1px solid #ccc;
            border-radius: 4px;
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
        }

        /*表格***************************************************************************************************/
        .statistic-data-table {
            width: 100%;
            font-size: 13px;
            text-align: center;
        }

        .statistic-data-table thead {
            background-color: #d5d5d5;

        }

        #name-keyword{
            width: 160px;
        }
        /***************************************************************************************************表格*/

        @media print {
            .no-print {
                display: none; /*隐藏不打印的部分*/
            }
        }
        /*翻页样式******************************************************************/
        .pagelist {
            display: table;
            margin: 0 auto;
            /*margin-left: 106px;*/
            /*border: 1px solid red;*/
            /*font-size: 0;*/
            background: #fff;
            height: 50px;
            line-height: 50px;
        }

        .pagelist ul
        {
            list-style:none;
            /*padding: 10px 0;*/
        }

        .pagelist ul li
        {
            display: inline;
            background-color: #e2e3e5;
            height: auto;
            /*padding: 10px 0;*/
        }
        .pagelist ul li:hover
        {
            background-color: #dddddd;
        }
        .pagelist a
        {
            color: #1b1e21;
            /*padding-top: 5px;*/
            /*padding-bottom: 5px;*/
            padding: 10px 10px;
            text-decoration:none;
        }
        .pagelist .active
        {
            background-color: #d5d5d5;
        }

        .pagelist .disabled button
        {
            opacity: 0.1;
        }
        .pagelist .prev,.pagelist .next
        {
            padding-right: 5px;
            padding-left: 5px;
        }


        /******************************************************************翻页样式*/
    </style>
</head>
<body>

<div class="container">
    <div class="row clearfix no-print">
        <div class="col-md-12 column">

            <div class="top-container">
                <div class="row">
                    <div class="col-md-10">

                        <div class="dropdown">
                            <button style="font-size: 30px" type="button" class="btn dropdown-toggle"
                                    data-toggle="dropdown">
                                总览页面
                            </button>
                            <div class="dropdown-menu">
                                <a class="dropdown-item" href="admin.html">管理页面</a>
                                <a class="dropdown-item" href="statistic_detail.html">详情页面</a>
                                <a class="dropdown-item" href="statistic.html">总览页面</a>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">

                        <div class="login-info">

                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
    <div class="row clearfix">
        <div class="col-md-12 column">
            <form class="search-data no-print" name="search_data">

                <div class="row top-control">
                    <div class="col-md-3 column">

                        <div class="input-group paper-select-div ">
                            <span class="input-group-addon departments">问卷：</span>
                            <select class="paper-select" name="que_id" id="paper-select">

                            </select>
                        </div>

                    </div>
                    <div class="col-md-3 column">


                        <div class="input-group">
                            <span class="input-group-addon">院系：</span>
                            <select class="academy-select" name="academy" id="dep-select">
                                <option value="0" selected>--学院--</option>
                                <option value="文学院">文学院</option>
                                <option value="马克思主义学院">马克思主义学院</option>
                                <option value="外国语学院">外国语学院</option>
                                <option value="法学院">法学院</option>
                                <option value="教育科学学院">教育科学学院</option>
                                <option value="历史文化与旅游学院">历史文化与旅游学院</option>
                                <option value="国际教育学院">国际教育学院</option>

                                <option value="数学与软件科学学院">数学与软件科学学院</option>
                                <option value="物理与电子工程学院">物理与电子工程学院</option>
                                <option value="化学与材料科学学院">化学与材料科学学院</option>
                                <option value="生命科学学院">生命科学学院</option>
                                <option value="地理与资源科学学院">地理与资源科学学院</option>
                                <option value="计算机科学学院">计算机科学学院</option>

                                <option value="经济与管理学院">经济与管理学院</option>
                                <option value="体育学院">体育学院</option>
                                <option value="工学院">工学院</option>
                                <option value="商学院">商学院</option>
                                <option value="影视与传媒学院">影视与传媒学院</option>

                                <option value="基础教学学院">基础教学学院</option>
                                <option value="教师教育与心理学院">教师教育与心理学院</option>
                                <option value="美术学院">美术学院</option>
                                <option value="音乐学院">音乐学院</option>
                                <option value="舞蹈学院">舞蹈学院</option>

                                <option value="服装与设计艺术学院">服装与设计艺术学院</option>
                                <option value="MBA/MPA教育中心">MBA/MPA教育中心</option>
                                <option value="职业技术学院">职业技术学院</option>
                                <option value="应用技术学院">应用技术学院</option>

                            </select>
                        </div>
                    </div>
                    <div class="col-md-3 column">
                        <div class="input-group">
                            <span class="input-group-addon instructor-name">姓名：</span>
                            <input type="text" id="name-keyword" />
                        </div>
                    </div>
                    <div class="col-md-3 column">

                        <button type="button" class="btn btn-sm" id="keyword-search">查询</button>
                        <!--<button type="button" class="btn btn-sm">重置</button>-->
                        <button type="button" class="btn btn-sm btn-export-Excel">导出Excel</button>
                        <button type="button" class="btn btn-sm btn-print">打印</button>

                    </div>
                </div>

            </form>

            <div class="row">
                <div class="col-md-12 statistic-data-table-div">
                    <div class="table-responsive">

                        <table class="statistic-data-table table table-bordered">
                            <thead>
                            <tr>
                                <td rowspan="2">序号</td>
                                <td rowspan="2">辅导员姓名</td>
                                <td rowspan="2">院系</td>
                                <td rowspan="2">院评价</td>
                                <td rowspan="2">平均分</td>
                                <td rowspan="2">考评参与人数</td>
                                <td rowspan="2">在校学生人数</td>
                                <td rowspan="2">评价学生比例</td>
                                <td rowspan="2">优良率</td>
                                <td rowspan="2">差率</td>
                                <td colspan="2">(95--85)分</td>
                                <td colspan="2">(84--75)分</td>
                                <td colspan="2">(74--60)分</td>
                                <td colspan="2">60分以下</td>
                            </tr>
                            <tr>
                                <td>人</td>
                                <td>%</td>
                                <td>人</td>
                                <td>%</td>
                                <td>人</td>
                                <td>%</td>
                                <td>人</td>
                                <td>%</td>

                            </tr>
                            </thead>

                            <tbody id="statistic-data-tbl">

                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="pagelist">

    </div>
</div>


<script>
    var __url_page_name__ = 'page';   // URL 中翻页参数的名字
    var __page__;       //URL 中的参数 page 的值
    var __pageSize__ = 15;  //每页显示条数的全局变量
    $(document).ready(function(){
        var reg = new RegExp("(^|&)(" + __url_page_name__ + "=)([^&]*)(&|$)", "i");
        var url_reg = window.location.href.match(reg);
        __page__ = url_reg === null ? 1 : url_reg[3];  //url中没有 page 参数默认为 1
        console.log(__page__);

    });

    var load_animation = {
        showAnim : function () {
            $('body').append('<div style="\n' +
                '    width: 100%;\n' +
                '    position: fixed;\n' +
                '    top: 0; ' +
                '    left: 0;' +
                '    height: 100%;\n' +
                '    background-color: rgba(255, 255, 255, 0.55);\n' +
                '" id="loading-progress">\n' +
                '    <progress style="\n' +
                '    position: relative;\n' +
                '    display:  block;\n' +
                '    margin:  auto;\n' +
                '    margin-top: 20%;\n' +
                '"></progress>\n' +
                '    <div style="text-align: center;">\n' +
                '        加载中...\n' +
                '    </div>\n' +
                '</div>');
        },
        removeAnim:function () {
            $('#loading-progress').remove();
        }
    };
    var page_func = {
        //btn bind function
        bind_func:function () {
            var _self_ = this;
            $('#keyword-search').click(function (e) {
                _self_.statistic_data_request(__page__ - 1, __pageSize__, $('#paper-select').val(), $('#dep-select').val());
            });

            $(".btn-export-Excel").click(function () {
                var file_name = $(".paper-select option:selected").text();
                var academy_name = $(".academy-select").val();
                if (academy_name !== "#") {
                    file_name = file_name + '-' + academy_name;
                }
                console.log(file_name);


                $(".statistic-data-table").table2excel({
                    exclude: ".noExl",  //有class = “noExl” 的行不被导出；
                    name: "Excel Document Name",
                    filename: file_name,
                    exclude_img: true,
                    exclude_links: true,
                    exclude_inputs: true
                });

            });
            $(".btn-print").click(function () {
                window.print();
            });
        },
        //get/post请求函数
        ajax_request:function (req_type,req_url,req_data,load_anim,callBack) {
            $.ajax({
                url:req_url,
                type:req_type,
                data:req_data,
                dataType:'json',
                beforeSend:function (xhr) {
                    if(load_anim == true){
                        load_animation.showAnim();
                    }
                },
                success:function (result,status,xhr) {
                    callBack(result);
                },
                complete:function(xhr,status){
                    if(load_anim == true){
                        load_animation.removeAnim();
                    }
                }
            });
        },
        //统计数据请求
        statistic_data_request:function (start_par, limit_par, paper_id_par, dep_par) {
            var _self_ = this;
            this.ajax_request(
                'get',
                'php/statistic_data.php',
                {
                    p_start: start_par === undefined ? 0 : start_par,
                    p_limit: limit_par === undefined ? __pageSize__ : limit_par,
                    paper_id: paper_id_par === undefined ? 0 : paper_id_par,
                    dep: dep_par === undefined ? 0 : dep_par,
                    name_keyword: $('#name-keyword').val()
                },
                true,
                function (result_data) {
                    _self_.statistic_data_append(result_data);
                }
            );
        },
        //填充数据表格
        statistic_data_append:function (src_data) {
            console.log(src_data);
            if(src_data.Status === 'success'){
                var data_tbl = $('#statistic-data-tbl');
                var html_text = '';
                var data_lists = $(src_data.Ret_Data);
                var no_num = 1;
                var totalCount = src_data.Num;
                data_lists.each(function () {
                    html_text += '<tr>\n' +
                        '                                <td>'+no_num+'</td>\n' +
                        '                                <td><a target="_blank" href="statistic_detail.html?' +
                        't_ybid='+this.teacher_id+'&paper_id='+this.paper_id+'&t_name='+encodeURIComponent(this.t_name) +
                        '&bad_per='+encodeURIComponent(this.bad_percent)+'&good_per='+encodeURIComponent(this.good_percent)+
                        '&dep='+encodeURIComponent(this.t_dep)+'&score='+this.t_dep_average+'&paper_title='+$('#paper-select').find("option:selected").html()+'" >'+this.t_name+'</a></td>\n' +
                        '                                <td>'+this.t_dep+'</td>\n' +
                        '                                <td> </td>\n' +
                        '                                <td>'+this.t_dep_average+'</td>\n' +
                        '                                <td>'+this.done_num+'</td>\n' +
                        '                                <td>'+this.all_num+'</td>\n' +
                        '                                <td>'+this.done_percent+'</td>\n' +
                        '                                <td>'+this.good_percent+'</td>\n' +
                        '                                <td>'+this.bad_percent+'</td>\n' +
                        '                                <td>'+this.distribution_A+'</td>\n' +
                        '                                <td>'+this.distribution_A / this.all_num+'</td>\n' +
                        '                                <td>'+this.distribution_B+'</td>\n' +
                        '                                <td>'+this.distribution_B / this.all_num+'</td>\n' +
                        '                                <td>'+this.distribution_C+'</td>\n' +
                        '                                <td>'+this.distribution_C / this.all_num+'</td>\n' +
                        '                                <td>'+this.distribution_D+'</td>\n' +
                        '                                <td>'+this.distribution_D / this.all_num+'</td>\n' +
                        '                            </tr>'
                    no_num++;
                });
                if(no_num === 1){
                    html_text = '<tr><td></td><td></td><td>没</td><td>有</td><td>数</td><td>据</td>' +
                        '<td>或</td><td>没</td><td>有</td><td>权</td>' +
                        '<td>限</td><td>查</td><td>看</td><td></td><td></td><td></td><td></td><td></td></tr>';
                }
                data_tbl.children().remove();
                data_tbl.append(html_text);
                console.log(no_num);
                if(no_num !== 1)
                {
                    this.page_turn(totalCount,8,8);
                }
            }else{
                alert(data.Error);
            }
        },
        //老师登陆判断
        teacherIfLog: function (callBack) {
            var _self_ = this;
            $.ajax({
                url: "php/teacher_log_valid.php",
                type: "GET",
                dataType: 'json',
                success: function (response) {
                    var data = response;
                    if (data.Status === 'failed') {
                        window.location.href = 'php/yb_log_deal.php';
                    }
                    else{
                        var t_ybid = data.Ret_Data.t_ybid;
                        var t_name = data.Ret_Data.t_name;
                        $('.login-info').html(
                            '<button class="btn btn-primary btn-sm" onclick="logout_request();">(' + t_name + ')注销</button>'
                        );
                        callBack();
                    }
                },
                error: function (result) {
                    console.log("加载错误");
                }
            });
        },
        //问卷列表选项填充
        paper_list_append:function (src_data) {
            var lists = $(src_data.Ret_Data);
            var html_text = '';
            lists.each(function () {
                html_text += '<option value="'+this.paper_id+'">'+this.title+'</option>'
            });
            $('#paper-select').html(html_text);
        },
        //问卷列表请求
        paper_lsit_request:function () {
            var _self_ = this;
            _self_.ajax_request(
                'get',
                'php/paper_list.php',
                {},
                false,
                function (data) {
                    if(data.Status === 'success'){
                        _self_.paper_list_append(data);
                    }else{
                        alert(data.Error);
                    }
                }
            )
        },
        //page_init
        page_init:function () {
            var _self_ = this;
            _self_.bind_func();
            _self_.teacherIfLog(function () {
                var paper_id_par = $('#paper-select').val();
                var dep_par = $('#dep-select').val();
                paper_id_par = paper_id_par === null ? 0 : paper_id_par;
                dep_par = dep_par === null ? 0 : dep_par;

                _self_.statistic_data_request(__page__ - 1, __pageSize__, paper_id_par, dep_par);
                _self_.paper_lsit_request();
            });
        },
        page_turn:function (totalCount,pageSize,buttonSize){
            console.log("page_turn");
            $(".pagelist").html(Pager({

                totalCount:totalCount, //总条数为150
                pageSize:__pageSize__,    //每页显示8条内容，默认10
                buttonSize:buttonSize,   //显示6个按钮，默认10
                pageParam:__url_page_name__,   //页码的参数名为\'p\'，默认为\'page\'
                className:'pagination',    //分页的样式
                prevButton:'<button class="btn">上一页</button>',       //上一页按钮
                nextButton:'<button class="btn">下一页</button>'       //下一页按钮

            }));
        }

    };




    page_func.page_init();

    //    1.向teacher_log_valid.php发送无参数get请求，判断老师是否登陆，没有登陆则将本页重定向跳转至oauth_log.php。
    //    2.向statistic_data.php发出get请求，获取到返回结果并呈现，实现统计数据呈现功能。
    //    3.向statistic_data.php发出带相应参数的get请求实现搜索功能，实现统计数据呈现功能。
</script>

</body>
</html>